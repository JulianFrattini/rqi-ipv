---
title: "Bayesian Analysis of the Impact of Passive Voice"
author: "Julian Frattini"
date: '2023-11-30'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(patchwork)

library(ggdag)

library(brms)
```

This document contains a Bayesian analysis of the hypotheses investigated by Femmer et al.^[Femmer, H., Kučera, J., & Vetrò, A. (2014, September). On the impact of passive voice requirements on domain modelling. In Proceedings of the 8th ACM/IEEE International Symposium on Empirical Software Engineering and Measurement (pp. 1-4).].

## Data Loading

We start by loading the data which is disclosed at https://doi.org/10.5281/zenodo.7499290.

```{r data-load}
participants <- read.csv(file="../data/participants.csv")
experience <- read.csv(file="../data/experience.csv")
requirements <- read.csv(file="../data/requirements.csv")
responses <- read.csv(file="../data/responses.csv")
```

Next, we join the four data frames to one. And adjust a few variables. This includes the following mutations:

1. The introduction of the `passive` variable indicating whether a row was produced by an active or passive voice requirement.
2. Trimming the number of missing actors, entities and associations: in the original data, some rows report a number of missing elements exceeding the number of expected elements, which makes no sense. 

Finally, the data frame is reduced to the relevant variables of interest.

```{r data-join}
d <- responses %>% 
  full_join(participants) %>% # add information about the participants
  full_join(experience) %>% # add information about the participants' experience
  full_join(requirements) %>% # get information about the expected actors etc. of the requirement
  mutate(
    passive = if_else(startsWith(PID, 'P'), TRUE, FALSE), # introduce a factor variable for passive voice

    actors.missing = if_else(MAct > EAct, EAct, MAct), # cutoff missing actors by expected actors
    actors.found = EAct-actors.missing, # inverse missed to found actors
    actors.expected = EAct, # spell out the variable
  
    associations.missing = if_else(MAsc > EAsc, EAsc, MAsc),
    associations.found = EAsc-associations.missing,
    associations.expected = EAsc,
    
    entities.missing = if_else(MEnt > EEnt, EEnt, MEnt),
    entities.found = EEnt-entities.missing,
    entities.expected = EEnt,
    
    REQuizPerformance = RExp) %>% 
  select(
    PID, RID,
    Age, Program, REQuizPerformance,
    ExpProgAca, ExpProgInd, ExpSEAca, ExpSEInd, ExpREAca, ExpREInd,
    passive,
    actors.expected, actors.found, actors.missing,
    associations.expected, associations.found, associations.missing,
    entities.expected, entities.found, entities.missing)
```

Additionally, we indicate categorical variables as such.

```{r data-factors}
cat_age <- c("19-24", "25-30", "31-40")
cat_exp <- c("no experience", "up to 6 months", "6 to 12 months", "more than 12 months")
cat_prg <- c("Unknown", "Bachelor", "Master", "Doctorate")


d$Age <- factor(d$Age, levels=cat_age, ordered=TRUE)

d$ExpProgAca <- factor(d$ExpProgAca, levels=cat_exp, ordered=TRUE)
d$ExpProgInd <- factor(d$ExpProgInd, levels=cat_exp, ordered=TRUE)
d$ExpSEAca <- factor(d$ExpSEAca, levels=cat_exp, ordered=TRUE)
d$ExpSEInd <- factor(d$ExpSEInd, levels=cat_exp, ordered=TRUE)
d$ExpREAca <- factor(d$ExpREAca, levels=cat_exp, ordered=TRUE)
d$ExpREInd <- factor(d$ExpREInd, levels=cat_exp, ordered=TRUE)

d$Program <- factor(d$Program, levels=cat_prg, ordered=TRUE)
```

Finally, visualize the variables of the data set to confirm that all looks correct.

```{r data-view}
str(d)
```

## Bayesian Analysis

### Causal Assumptions

(TODO: DAG)

(TODO: adjustment sets)

### Formula

```{r formula}
formula <- (actors.missing | trials(actors.expected) ~ 
              1 + # standard success in the task of finding actors
              passive + # impact of the use of passive voice
              (1|RID) + # impact of the difficulty of the individual requirements
              (1|PID) + # impact of the skill of individual participants
              mo(ExpREAca) + # impact of the participants academic experience in RE
              mo(ExpREInd)) # impact of the participants industrial experience in RE

get_prior(formula, family=binomial, data=d)
```

### Priors

```{r priors}
priors <- c(prior(normal(0, 1), class = Intercept),
            prior(normal(0, 1), class = b),
            prior(weibull(2, 1), class = sd, coef = Intercept, group = RID),
            prior(weibull(2, 1), class = sd, coef = Intercept, group = PID),
            prior(dirichlet(4), class = simo, coef = moExpREAca1),
            prior(dirichlet(4), class = simo, coef = moExpREInd1),
            prior(exponential(1), class = sd))
```

```{r model-prior}
m.prior <-
  brm(data = d, family = binomial, formula, prior = priors,
    iter = 4000, warmup = 1000, chains = 4, cores = 4,
    seed = 4, sample_prior="only",
    #file = "fits/b09.01.prior"
  )
```

```{r prior-predictive-check}
ndraws <- 400

priorpc <- brms::pp_check(m.prior, type="bars", ndraws=ndraws)

priorpc
```

```{r model}
m <-
  brm(data = d, family = binomial, formula, prior = priors,
    iter = 4000, warmup = 1000, chains = 4, cores = 4,
    seed = 4,
    #file = "fits/b09.01.prior"
  )
```

```{r posterior-predictive-check}
postpc <- brms::pp_check(m, type="bars", ndraws=ndraws)

postpc
```

```{r summary}
summary(m)
```

```{r}
conditional_effects(m, effects="passive")
```

